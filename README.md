# Modern Excel PMS（プロジェクト管理システム）総合仕様書

Excel 単体で Jira や Asana に近い UX を実現することを目的にした「Modern Excel PMS」の実装仕様をまとめます。開発者がそのままブックを構築できるよう、シート構成・関数・自動化・UI 方針まで網羅しています。

---
## 1. プロジェクト概要
### 1.1 目的
* Excel でも SaaS 型ツール並みの視認性・自動化を提供し、案件〜施策〜WBS を一元管理する。
* 「多重入力」「ガント手描き」「行並び替えの煩雑さ」など、従来の表管理が抱える課題を解消する。

### 1.2 ゴール
* 案件（親）⇔施策（子）⇔WBS（孫）の **3 層完全データ連携**。
* 数式と条件付き書式による **ガントチャート完全自動化**。
* モダン Excel 関数による **動的カンバンボード**。

### 1.3 想定環境
* **Excel バージョン:** Microsoft 365（動的配列関数を使用）。
* **ファイル形式:** マクロ有効ブック（`.xlsm`）。
* **外部依存:** なし。VBA は UI 補助のみでロジックは数式に寄せる。

---
## 2. アーキテクチャ
### 2.1 Hub & Spoke モデル
* **Hub:** `Case_Master` / `Measure_Master`。各 WBS シートから進捗・リンクを吸い上げる。
* **Spoke:** `PRJ_xxx`（`Template` 由来の詳細 WBS）。
* 吸い上げは `INDIRECT`、`FILTER` など動的参照を前提とし、作業用の中間セルは原則不要。

### 2.2 使用技術
1. **Modern Excel 関数:** `FILTER`, `SORT`, `UNIQUE`, `XLOOKUP`, `LET`, `SEQUENCE`。
2. **条件付き書式:** ガント描画・ステータスバッジ・進捗バー。
3. **VBA:** UI 補助（行入れ替え、シート複製、新規作成、ダブルクリックイベントによるカンバン更新）。計算は数式に集約。

---
## 3. シート構成
| No | シート名 | 役割 | 階層 | 備考 |
| --- | --- | --- | --- | --- |
| 1 | `Case_Master` | 案件管理（ポートフォリオ） | 親 | 顧客単位の予算・進捗管理 |
| 2 | `Measure_Master` | 施策管理（プロジェクト） | 子 | 案件に紐づく施策一覧・WBS へのハブ |
| 3 | `Kanban_View` | タスク可視化 | View | 選択した施策のタスクをカード表示 |
| 4 | `Template` | WBS ひな形 | 原型 | `PRJ_xxx` 作成時のコピー元（非表示推奨） |
| 5 | `PRJ_xxx` | 詳細 WBS | 孫 | `Template` をコピーして量産 |
| 6 | `Config` | 設定 | - | 祝日、担当者、プルダウンリスト |

---
## 4. シート詳細仕様
### 4.1 Case_Master（案件管理）
* **主キー:** A 列に案件 ID（Unique）。
* **案件名:** B 列。
* **施策数:** D 列。`=COUNTIF(Measure_Master!B:B, A行の値)`
* **平均進捗:** E 列。`=AVERAGEIF(Measure_Master!B:B, A行の値, Measure_Master!G:G)`
* **ドリルダウン:** H1 のプルダウンで案件 ID を選択すると、`FILTER` により右側パネル（G3 以降）へ該当施策がスピル表示される。

### 4.2 Measure_Master（施策管理）
* **親案件 ID:** B 列。`Case_Master` の ID をデータ検証で選択。
* **WBS リンク:** E 列。シート名を F 列に入力し、`=HYPERLINK("#'" & F行 & "'!A1", "WBSを開く")`。
* **実進捗:** G 列。各 WBS シートのヘッダーセル（`J2`）を参照し、シート名未入力時は空欄、参照切れ時は「未リンク」を返す。`=IF(F行="","",IFERROR(INDIRECT("'" & F行 & "'!J2"), "未リンク"))`

### 4.3 Template / PRJ_xxx（詳細 WBS）
* **ヘッダー領域:**
  * `J2` に工数加重平均（`SUMPRODUCT(工数,進捗率)/SUM(工数)`）で全体進捗率を算出し、`Measure_Master` から参照。
  * `K2` にガントの基準日を置き、`K3:AN3` に 30 列分の日付シーケンスをスピルさせてタイムラインを形成。
* **メインテーブル:**
  * **階層:** A 列に `Lv`（1〜3）。条件付き書式で Lv1=太字背景、Lv2/3 はインデント。
  * **日付計算:** 終了日 = `WORKDAY(開始日, 工数-1, Config!祝日)`。
  * **ステータス自動判定:**
    * 進捗 100% → 完了。
    * 期限切れ＆未完 → 遅延。
    * 開始日到来 → 進行中。
    * それ以外 → 未着手。
  * **データ検証:** 担当者（C列）とステータス（H列）は `Config` のマスタ範囲からプルダウン選択。
  * **ガント条件付き書式（優先順位順）：**
    1. 今日ライン: 日付列が今日の場合に右罫線（#E74C3C）。
    2. 完了: `完了` ステータスのタスク期間をグレー（#95A5A6）。
    3. 遅延: `遅延` ステータスのタスク期間を赤（#E74C3C）。
    4. 通常: `未着手` / `進行中` の期間を青（#3498DB）。
  * **ステータスバッジ条件付き書式:** `H5:H104` に対し、`未着手` #BDC3C7 / `進行中` #3498DB / `遅延` #E74C3C / `完了` #2ECC71 を塗り分け、文字色は進行中〜完了で白に統一。
  * **カラーパレットの一覧:** ルールとカラーの対応を `docs/gantt_palette.svg` にまとめた。

![ガントとステータスのカラーパレット](docs/gantt_palette.svg)

### 4.4 Kanban_View（動的カンバン）
* **セレクター:** `B2` で施策（WBS シート名）を選択。
* **スイムレーン:** To Do / Doing / Done の 3 列。
* **表示ロジック:** `FILTER` で該当ステータスのタスクを抽出し、`タスク名 & CHAR(10) & 担当 & 期限` をカード風に表示。
* **操作ロジック (VBA):**
  * カードセルをダブルクリックすると、対象 WBS シートのステータスを書き換え。
  * 再計算によりカードが列移動し、簡易アニメーションとなる。

### 4.5 Config（設定）
* 祝日リスト、担当者マスタ、プルダウン候補を保持。
* WBS の日付計算やデータ検証がこのシートを参照。
* 担当者マスタ（D列）とステータス候補（F列）は `Template` / `PRJ_xxx` のデータ検証に利用される。

### 4.6 エラーハンドリングとデータ入力ポリシー
* **INDIRECT の参照切れ:**
  * `Measure_Master!G列` は `IF(F=\"\",\"\",IFERROR(INDIRECT(),\"未リンク\"))` の構造とし、シート名未入力時は空欄、参照不可時は「未リンク」を返して計画未連携のセルを判別しやすくする。
  * `Kanban_View` の `FILTER` 連鎖は `IFERROR` で包み、選択したシートが存在しない場合は「選択したWBSシートが見つかりません」と明示して #REF! を防ぐ。
* **データ検証外入力:** 案件 ID（`Case_Master!H1`、`Measure_Master!B列`）、WBS シート名セレクター（`Kanban_View!B2`）はリスト型データ検証に `stop` スタイルのエラーアラートと入力メッセージを設定する。プルダウン外の値は即エラーで再入力を促し、B 列の案件 ID は空欄を許可しない。貼り付けで検証をすり抜けた場合に備え、リスト外文字列を赤背景にする条件付き書式（`=ISERROR(MATCH(対象セル, 参照リスト, 0))`）の併用を推奨する。
* **警告の見せ方:** 参照切れで「未リンク」や警告メッセージが出た行は、条件付き書式で背景色を付ける運用を想定し、担当者にリカバリーを促す。

---
## 5. UI / UX 指針
* **フォント:** 英数字 = `Segoe UI`、日本語 = `Meiryo UI` または `Yu Gothic UI`（9〜10pt）。
* **配色:**
  * ヘッダー背景: `#2C3E50`、文字: 白。
  * ステータス色: 完了 `#2ECC71` / 進行中 `#3498DB` / 遅延 `#E74C3C`。
* **表示:** グリッド線オフ。ヘッダー行と ID 列をウィンドウ枠固定。
* **デザインコンセプト:** 「Non-Excel Look（脱エクセル）」。

---
## 6. 実装フェーズ（ロードマップ）
1. **Phase 1: コアエンジン** — `Template` の数式・条件付き書式・ガントを実装し、`Config` で祝日を整備。
2. **Phase 2: データ連携** — `Case_Master` / `Measure_Master` を作成し、`INDIRECT` で進捗吸い上げを確認。
3. **Phase 3: 自動化 (VBA)** — 行の入れ替え（Up/Down ボタン）、`Template` コピーによる新規施策追加を実装。
4. **Phase 4: ビジュアライズ** — `Kanban_View` の SPILL 関数とダブルクリックイベントを実装。
5. **Phase 5: デザイン仕上げ** — フォント統一、配色適用、目盛線オフなど UI 調整。

---
## 7. 開発・運用ヒント
* **命名:** 詳細 WBS シートは `PRJ_001` のように連番管理すると `INDIRECT` 参照が簡潔。
* **バックアップ:** VBA を含むため Git ではバイナリ管理。仕様は本 README でバージョン管理し、数式変更点はコメント付きで記録する。
* **拡張余地:** 進捗の加重平均化、リソース負荷計算、レポート出力用の Pivot 追加などを後続フェーズで検討。

---

## 8. 開発開始前チェックリスト
この仕様だけでブック構築に着手できるよう、最初に確認すべき前提をまとめます。

1. **環境:** Microsoft 365 の Excel を使用する（動的配列関数前提）。
2. **ファイル:** `.xlsm` 形式で新規ブックを作成し、グリッド線を非表示にする。
3. **シート準備:** `Config` → `Template` → `Case_Master` → `Measure_Master` → `Kanban_View` の順で作成。
4. **命名規約:** WBS シートは `PRJ_001` 形式で連番。`Measure_Master!F列` にシート名を登録。
5. **祝日設定:** `Config` に祝日リストを入力し、`WORKDAY` の第三引数で参照。
6. **データ検証:** 案件 ID / 担当者などのプルダウンを `Config` のマスタ範囲にひも付ける。
7. **VBA 設定:** マクロを有効化し、`Template` の Up/Down ボタンとダブルクリックイベントを `Kanban_View` に実装。

---

## 9. 最初の実装ステップ（作業手順）
1. **Config シート**: 祝日リスト、担当者マスタ、プルダウン候補を作成し、名前付き範囲を設定。
2. **Template シート**: 
   - メインテーブルを作成し、`Lv` に応じた条件付き書式（太字・インデント）を設定。
   - 開始日・工数・終了日（`WORKDAY`）・進捗率の列を定義し、`J2` で全体進捗率を計算。
   - ガント用の条件付き書式 4 種を右側の日付列に適用。
   - 行入れ替えボタン（Up/Down）を配置し、行スワップ用の VBA を割当。
3. **Case_Master / Measure_Master**: 表ヘッダーを作成し、前述の数式（`COUNTIF` / `AVERAGEIF` / `INDIRECT` / `HYPERLINK`）を入力。
4. **PRJ_xxx シート**: `Template` をコピーして 1 枚作成し、サンプルタスクを入力して計算・ガント挙動を確認。
5. **Kanban_View**: `B2` のデータ検証で WBS シート名を選択、`FILTER` でステータス別のカード表示を作成。ダブルクリックイベントでステータス更新マクロを紐付け。
6. **総合動作確認**: `Case_Master` のドリルダウン、`Measure_Master` のリンク、ガント表示、カンバン移動が一通り動くかを確認し、必要に応じて列幅・配色を微調整。

---

## 10. 同梱物と自動生成スクリプト
以前は自動生成した雛形ブック `ModernExcelPMS.xlsx` を同梱していましたが、バイナリのため変更差分が把握しづらく、同期が困難なことからリポジトリには含めない方針にしました。必要に応じて以下の手順でいつでも再生成できます。

```bash
python tools/build_workbook.py
```

実行するとリポジトリ直下にマクロ有効ブック `ModernExcelPMS.xlsm` が生成されます（`.gitignore` で除外済み）。既存ファイルがあれば同名で上書きされるため、再作成時は上記コマンドを実行してください。生成されるブックの主な内容は以下の通りです。

- **Config**: 祝日・担当者・ステータス候補のサンプルを収録。
- **Template / PRJ_001**: WBS テーブル（Lv/タスク/担当/開始日/工数/終了日/進捗率/ステータス/備考）と、`WORKDAY`・`IFS`・工数加重平均による全体進捗率計算を備えた自動計算。
- **Case_Master**: `COUNTIF` と `AVERAGEIF` で施策数・平均進捗を算出。
- **Measure_Master**: `HYPERLINK` で WBS にジャンプし、`INDIRECT` で進捗を吸い上げ。
- **Kanban_View**: `B2` のプルダウンから WBS シート名を選択し、`FILTER`/`LET`/`MAP` で To Do / Doing / Done のカード文字列をスピル表示。
- **VBA モジュール**: `docs/vba` 配下の `modWbsCommands`（行移動・テンプレート複製・ステータス更新）、`Kanban_View`（ダブルクリックイベント）、`ThisWorkbook`（シート名採番）、`modProtection`（保護ユーティリティ）を `xl/vbaProject.bin` として同梱。

`tools/build_workbook.py` はレポート生成にも対応しています。以下のオプションを組み合わせると、ブックの構成をテキストと PDF で同時に保存できます。

```bash
python tools/build_workbook.py --projects 3 --sample-first --output ModernExcelPMS.xlsm \
  --report-output workbook_report.md --pdf-output workbook_report.pdf
```

上記の例では、PRJ シート 3 枚のブックを作成し、進捗レポートを Markdown と PDF で出力します。

### レポート出力内容

レポートには以下の情報が含まれます。

| セクション | 内容 |
|------------|------|
| **基本情報** | 生成日時、出力先パス、PRJ シート数、サンプルデータ有無 |
| **進捗サマリー** | 全体進捗率（工数加重平均）、総工数・消化工数 |
| **ステータス別集計** | 未着手/進行中/遅延/完了 のタスク数と割合（バーチャート付き） |
| **タスク完了率** | 完了タスク数 / 全タスク数（案件消化度） |
| **施策別進捗** | 各施策（PRJ_xxx）の進捗率 |
| **担当者別負荷** | 担当者ごとの総工数と消化率 |
| **マスターデータ** | 案件一覧、施策一覧、ステータス候補、担当者マスタ |

**注意:** 進捗サマリーは `--sample-first` または `--sample-all` オプション指定時のみ出力されます。サンプルデータがない場合はマスターデータのみ出力されます。

### レポート出力例

```
==================================================
Modern Excel PMS 生成レポート
==================================================

## 基本情報
生成日時: 2025-12-13 12:20
PRJ シート数: 2
サンプルデータ: 最初の1枚に配置

--------------------------------------------------
## 進捗サマリー (サンプルデータ)
--------------------------------------------------

全体進捗率: 35.0%
  - 総工数: 10 人日
  - 消化工数: 3.5 人日

ステータス別タスク数:
  未着手   :  1 ( 33.3%) ######
  進行中   :  1 ( 33.3%) ######
  遅延    :  0 (  0.0%)
  完了    :  1 ( 33.3%) ######

タスク完了率: 1/3 (33.3%)

施策別進捗:
  - ME-001 (LP 改修): 35.0%
  - ME-002 (SFA 導入 PoC): -- (データなし)

担当者別負荷:
  - DEV_鈴木: 5 人日 (消化 0.0%)
  - PM_佐藤: 2 人日 (消化 100.0%)
  - TL_田中: 3 人日 (消化 50.0%)
```

### マクロ操作手順と手動テストメモ
以下の操作を手元の Excel で確認し、ボタン・イベントが意図通り動くことを確認した。

1. **Template の行入れ替えボタン**
   * `Template`（もしくは複製した `PRJ_xxx`）でタスク行のセルを選択し、Up/Down ボタンを押下。
   * 選択行が範囲内で上下にスワップされ、`タスク名` とステータス列が合わせて移動することを確認。
2. **Template 複製ボタン**
   * `Template` で複製ボタンを押下。
   * 新しいシートが `PRJ_003` のように連番採番され、ブック末尾に追加されることを確認。
3. **Kanban_View のカードダブルクリック**
   * `Kanban_View!B2` で対象 WBS を選択後、`To Do`/`Doing`/`Done` 列に表示されたカードをダブルクリック。
   * 対応する WBS の `H列` ステータスが `未着手`/`進行中`/`完了` に書き換わり、再計算でカードが移動することを確認。

---

## 11. VBA モジュール構成（Phase 3 で実装）
VBA で自動化する主要機能と配置モジュールを事前に定義しておきます。`tools/build_workbook.py` の `VBA_MODULE_PLAN` でも同じ構成を持ち、後続のコード生成で参照します。

- **標準モジュール `modWbsCommands`**
  - `MoveTaskRowUp` / `MoveTaskRowDown`: `Template` / `PRJ_xxx` シートの Up/Down ボタンから呼び出し、選択行を上下にスワップする。
  - `DuplicateTemplateSheet`: `Template` を複製し、`ThisWorkbook.NextProjectSheetName` で採番したシート名を付与する。
  - `UpdateTaskStatusFromKanban`: カンバンセルから対象タスクを特定し、WBS 側のステータスを書き換える共通処理。
- **シートモジュール `Kanban_View`**
  - `Worksheet_BeforeDoubleClick`: カードセルのダブルクリックで `UpdateTaskStatusFromKanban` を呼び出し、セル編集をキャンセルする。
- **ThisWorkbook モジュール**
  - `NextProjectSheetName`: 既存の `PRJ_xxx` を走査して次の連番を返し、テンプレート複製時のシート名として使用する。

---

## 12. 残課題 / TODO
フェーズ 1〜3 で計画していた主要項目は完了済みです。

**完了済み:**
* **VBA 自動化**: 行入れ替え、テンプレート複製、カンバンのダブルクリック更新を実装し、`.xlsm` 出力に一本化。
* **エラーハンドリング**: 参照切れ時の表示やデータ検証のエラーメッセージを整備し、運用時のリカバリ方法を README に明記。
* **パフォーマンス検証**: 大規模 WBS での `INDIRECT`/`FILTER` の再計算時間を計測し、推奨運用をドキュメント化。
* **シート保護**: `build_workbook.py` でシート保護・セルロック・パスワードハッシュを自動適用。環境変数 `PMS_SHEET_PASSWORD` でパスワードを変更可能。
* **保護検証手順**: [docs/sheet_protection_test.md](docs/sheet_protection_test.md) にテストシナリオを整備。

**残タスク:**
* **Up/Down ボタン (DrawingObjects)**: ビルドスクリプトでの自動生成は未対応。Excel で手動追加し、`modWbsCommands.MoveTaskRowUp` / `MoveTaskRowDown` をマクロ割当すること。

今後は運用で得たフィードバックに応じてブラッシュアップを行う想定です。詳細な運用・設定手順は直下のセクションで参照してください。

---

## 13. シート保護とパスワード運用
シートごとの編集可能列と保護対象、`.xlsm` 出力時の保護適用手順、VBA による解除・再適用ユーティリティ、パスワード共有・変更の手順を [docs/sheet_protection_plan.md](docs/sheet_protection_plan.md) にまとめた。検証手順は [docs/sheet_protection_test.md](docs/sheet_protection_test.md) を参照。ブック生成や運用前に必ず確認すること。

## 14. ライセンス
本リポジトリのライセンスは [LICENSE](LICENSE) を参照してください。
