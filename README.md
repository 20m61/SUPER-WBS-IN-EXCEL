# Modern Excel PMS（プロジェクト管理システム）総合仕様書

Excel 単体で Jira や Asana に近い UX を実現することを目的にした「Modern Excel PMS」の実装仕様をまとめます。開発者がそのままブックを構築できるよう、シート構成・関数・自動化・UI 方針まで網羅しています。

---
## 1. プロジェクト概要
### 1.1 目的
* Excel でも SaaS 型ツール並みの視認性・自動化を提供し、案件〜施策〜WBS を一元管理する。
* 「多重入力」「ガント手描き」「行並び替えの煩雑さ」など、従来の表管理が抱える課題を解消する。

### 1.2 ゴール
* 案件（親）⇔施策（子）⇔WBS（孫）の **3 層完全データ連携**。
* 数式と条件付き書式による **ガントチャート完全自動化**。
* モダン Excel 関数による **動的カンバンボード**。

### 1.3 想定環境
* **Excel バージョン:** Microsoft 365（動的配列関数を使用）。
* **ファイル形式:** マクロ有効ブック（`.xlsm`）。
* **外部依存:** なし。VBA は UI 補助のみでロジックは数式に寄せる。

---
## 2. アーキテクチャ
### 2.1 Hub & Spoke モデル
* **Hub:** `Case_Master` / `Measure_Master`。各 WBS シートから進捗・リンクを吸い上げる。
* **Spoke:** `PRJ_xxx`（`Template` 由来の詳細 WBS）。
* 吸い上げは `INDIRECT`、`FILTER` など動的参照を前提とし、作業用の中間セルは原則不要。

### 2.2 使用技術
1. **Modern Excel 関数:** `FILTER`, `SORT`, `UNIQUE`, `XLOOKUP`, `LET`, `SEQUENCE`。
2. **条件付き書式:** ガント描画・ステータスバッジ・進捗バー。
3. **VBA:** UI 補助（行入れ替え、シート複製、新規作成、ダブルクリックイベントによるカンバン更新）。計算は数式に集約。

---
## 3. シート構成
| No | シート名 | 役割 | 階層 | 備考 |
| --- | --- | --- | --- | --- |
| 1 | `Case_Master` | 案件管理（ポートフォリオ） | 親 | 顧客単位の予算・進捗管理 |
| 2 | `Measure_Master` | 施策管理（プロジェクト） | 子 | 案件に紐づく施策一覧・WBS へのハブ |
| 3 | `Kanban_View` | タスク可視化 | View | 選択した施策のタスクをカード表示 |
| 4 | `Template` | WBS ひな形 | 原型 | `PRJ_xxx` 作成時のコピー元（非表示推奨） |
| 5 | `PRJ_xxx` | 詳細 WBS | 孫 | `Template` をコピーして量産 |
| 6 | `Config` | 設定 | - | 祝日、担当者、プルダウンリスト |

---
## 4. シート詳細仕様
### 4.1 Case_Master（案件管理）
* **主キー:** A 列に案件 ID（Unique）。
* **案件名:** B 列。
* **施策数:** D 列。`=COUNTIF(Measure_Master!B:B, A行の値)`
* **平均進捗:** E 列。`=AVERAGEIF(Measure_Master!B:B, A行の値, Measure_Master!G:G)`
* **ドリルダウン:** H1 のプルダウンで案件 ID を選択すると、`FILTER` により右側パネル（G3 以降）へ該当施策がスピル表示される。

### 4.2 Measure_Master（施策管理）
* **親案件 ID:** B 列。`Case_Master` の ID をデータ検証で選択。
* **WBS リンク:** E 列。シート名を F 列に入力し、`=HYPERLINK("#'" & F行 & "'!A1", "WBSを開く")`。
* **実進捗:** G 列。各 WBS シートのヘッダーセル（`J2`）を参照。`=INDIRECT("'" & F行 & "'!J2")`

### 4.3 Template / PRJ_xxx（詳細 WBS）
* **ヘッダー領域:**
  * `J2` に工数加重平均（`SUMPRODUCT(工数,進捗率)/SUM(工数)`）で全体進捗率を算出し、`Measure_Master` から参照。
* **メインテーブル:**
  * **階層:** A 列に `Lv`（1〜3）。条件付き書式で Lv1=太字背景、Lv2/3 はインデント。
  * **日付計算:** 終了日 = `WORKDAY(開始日, 工数-1, Config!祝日)`。
  * **ステータス自動判定:**
    * 進捗 100% → 完了。
    * 期限切れ＆未完 → 遅延。
    * 開始日到来 → 進行中。
    * それ以外 → 未着手。
  * **データ検証:** 担当者（C列）とステータス（H列）は `Config` のマスタ範囲からプルダウン選択。
  * **ガント条件付き書式（優先順位順）：**
    1. 今日の線（右赤罫線）。
    2. 完了タスク（グレー塗りつぶし）。
    3. 遅延タスク（赤塗りつぶし）。
    4. 通常期間（青塗りつぶし）。

### 4.4 Kanban_View（動的カンバン）
* **セレクター:** `B2` で施策（WBS シート名）を選択。
* **スイムレーン:** To Do / Doing / Done の 3 列。
* **表示ロジック:** `FILTER` で該当ステータスのタスクを抽出し、`タスク名 & CHAR(10) & 担当 & 期限` をカード風に表示。
* **操作ロジック (VBA):**
  * カードセルをダブルクリックすると、対象 WBS シートのステータスを書き換え。
  * 再計算によりカードが列移動し、簡易アニメーションとなる。

### 4.5 Config（設定）
* 祝日リスト、担当者マスタ、プルダウン候補を保持。
* WBS の日付計算やデータ検証がこのシートを参照。
* 担当者マスタ（D列）とステータス候補（F列）は `Template` / `PRJ_xxx` のデータ検証に利用される。

---
## 5. UI / UX 指針
* **フォント:** 英数字 = `Segoe UI`、日本語 = `Meiryo UI` または `Yu Gothic UI`（9〜10pt）。
* **配色:**
  * ヘッダー背景: `#2C3E50`、文字: 白。
  * ステータス色: 完了 `#2ECC71` / 進行中 `#3498DB` / 遅延 `#E74C3C`。
* **表示:** グリッド線オフ。ヘッダー行と ID 列をウィンドウ枠固定。
* **デザインコンセプト:** 「Non-Excel Look（脱エクセル）」。

---
## 6. 実装フェーズ（ロードマップ）
1. **Phase 1: コアエンジン** — `Template` の数式・条件付き書式・ガントを実装し、`Config` で祝日を整備。
2. **Phase 2: データ連携** — `Case_Master` / `Measure_Master` を作成し、`INDIRECT` で進捗吸い上げを確認。
3. **Phase 3: 自動化 (VBA)** — 行の入れ替え（Up/Down ボタン）、`Template` コピーによる新規施策追加を実装。
4. **Phase 4: ビジュアライズ** — `Kanban_View` の SPILL 関数とダブルクリックイベントを実装。
5. **Phase 5: デザイン仕上げ** — フォント統一、配色適用、目盛線オフなど UI 調整。

---
## 7. 開発・運用ヒント
* **命名:** 詳細 WBS シートは `PRJ_001` のように連番管理すると `INDIRECT` 参照が簡潔。
* **バックアップ:** VBA を含むため Git ではバイナリ管理。仕様は本 README でバージョン管理し、数式変更点はコメント付きで記録する。
* **拡張余地:** 進捗の加重平均化、リソース負荷計算、レポート出力用の Pivot 追加などを後続フェーズで検討。

---

## 8. 開発開始前チェックリスト
この仕様だけでブック構築に着手できるよう、最初に確認すべき前提をまとめます。

1. **環境:** Microsoft 365 の Excel を使用する（動的配列関数前提）。
2. **ファイル:** `.xlsm` 形式で新規ブックを作成し、グリッド線を非表示にする。
3. **シート準備:** `Config` → `Template` → `Case_Master` → `Measure_Master` → `Kanban_View` の順で作成。
4. **命名規約:** WBS シートは `PRJ_001` 形式で連番。`Measure_Master!F列` にシート名を登録。
5. **祝日設定:** `Config` に祝日リストを入力し、`WORKDAY` の第三引数で参照。
6. **データ検証:** 案件 ID / 担当者などのプルダウンを `Config` のマスタ範囲にひも付ける。
7. **VBA 設定:** マクロを有効化し、`Template` の Up/Down ボタンとダブルクリックイベントを `Kanban_View` に実装。

---

## 9. 最初の実装ステップ（作業手順）
1. **Config シート**: 祝日リスト、担当者マスタ、プルダウン候補を作成し、名前付き範囲を設定。
2. **Template シート**: 
   - メインテーブルを作成し、`Lv` に応じた条件付き書式（太字・インデント）を設定。
   - 開始日・工数・終了日（`WORKDAY`）・進捗率の列を定義し、`J2` で全体進捗率を計算。
   - ガント用の条件付き書式 4 種を右側の日付列に適用。
   - 行入れ替えボタン（Up/Down）を配置し、行スワップ用の VBA を割当。
3. **Case_Master / Measure_Master**: 表ヘッダーを作成し、前述の数式（`COUNTIF` / `AVERAGEIF` / `INDIRECT` / `HYPERLINK`）を入力。
4. **PRJ_xxx シート**: `Template` をコピーして 1 枚作成し、サンプルタスクを入力して計算・ガント挙動を確認。
5. **Kanban_View**: `B2` のデータ検証で WBS シート名を選択、`FILTER` でステータス別のカード表示を作成。ダブルクリックイベントでステータス更新マクロを紐付け。
6. **総合動作確認**: `Case_Master` のドリルダウン、`Measure_Master` のリンク、ガント表示、カンバン移動が一通り動くかを確認し、必要に応じて列幅・配色を微調整。

---

## 10. 同梱物と自動生成スクリプト
以前は自動生成した雛形ブック `ModernExcelPMS.xlsx` を同梱していましたが、バイナリのため変更差分が把握しづらく、同期が困難なことからリポジトリには含めない方針にしました。必要に応じて以下の手順でいつでも再生成できます。

```bash
python tools/build_workbook.py
```

実行するとリポジトリ直下に `ModernExcelPMS.xlsx` が生成されます（`.gitignore` で除外済み）。既存ファイルがあれば同名で上書きされるため、再作成時は上記コマンドを実行してください。生成されるブックの主な内容は以下の通りです。

- **Config**: 祝日・担当者・ステータス候補のサンプルを収録。
- **Template / PRJ_001**: WBS テーブル（Lv/タスク/担当/開始日/工数/終了日/進捗率/ステータス/備考）と、`WORKDAY`・`IFS`・工数加重平均による全体進捗率計算を備えた自動計算。
- **Case_Master**: `COUNTIF` と `AVERAGEIF` で施策数・平均進捗を算出。
- **Measure_Master**: `HYPERLINK` で WBS にジャンプし、`INDIRECT` で進捗を吸い上げ。
- **Kanban_View**: `B2` のプルダウンから WBS シート名を選択し、`FILTER`/`LET`/`MAP` で To Do / Doing / Done のカード文字列をスピル表示。

---

## 11. 残課題 / TODO
開発を進めるにあたり、現時点で決めきれていない事項や追加で詰めるべきタスクを整理します。

1. **VBA モジュール構成の明文化**: 行入れ替え・シート複製・ダブルクリックイベントをどのモジュール（標準/シート/ThisWorkbook）に配置するかを決め、プロシージャ名を統一する。
2. **エラーハンドリング方針**: `INDIRECT` で参照先が存在しない場合の表示（空欄／エラーメッセージ）や、データ検証外の値が入力された際の挙動を定義する。
3. **パフォーマンス確認**: WBS が多数になる場合に `INDIRECT`・`FILTER` が重くならないかを検証し、必要ならマクロでの再計算制御を検討する。
4. **テンプレート保護レベル**: `Template`・`Config` を保護するかどうか、パスワード設定の有無、保護範囲（ガント列のみ編集不可など）を決定する。

---

## 12. ライセンス
本リポジトリのライセンスは [LICENSE](LICENSE) を参照してください。
