# シート保護 検証手順書

`build_workbook.py` で生成した `.xlsm` ブックのシート保護が正しく機能しているかを確認するためのテストシナリオ。

## 前提条件

1. `python3 tools/build_workbook.py --projects 2 --sample-first` でブックを生成済み
2. Microsoft 365 Excel (Windows/Mac) で開く
3. マクロを有効化している

---

## テストシナリオ

### (a) PRJ シートの行挿入可否

| 手順 | 操作 | 期待結果 |
|------|------|----------|
| 1 | `PRJ_001` シートを開く | シートが表示される |
| 2 | タスク行 (5〜104 行目) のセルを選択 | 選択可能 |
| 3 | 右クリック → 「行の挿入」を選択 | 行が挿入される（許可） |
| 4 | `Case_Master` シートを開く | シートが表示される |
| 5 | データ行のセルを選択し、右クリック → 「行の挿入」 | 挿入が禁止される（エラーまたはグレーアウト） |

### (b) 編集可能セルと保護セルの確認

| シート | 編集可能セル (成功すべき) | 保護セル (失敗すべき) |
|--------|---------------------------|------------------------|
| Config | B4, D4, F4 (マスタデータ) | A1 (見出し) |
| Template / PRJ_001 | A5, B5, C5, D5, E5, G5, H5, I5 (タスク入力) | F5 (終了日=数式), J2 (全体進捗), K3 (ガント日付) |
| Case_Master | A2, B2, C2 (案件入力), H1 (案件選択) | D2 (施策数=数式), G3 (ドリルダウン=数式) |
| Measure_Master | A2, B2, C2, D2, F2, H2 (施策入力) | E2 (WBSリンク=数式), G2 (実進捗=数式) |
| Kanban_View | B2 (WBSシート名選択) | B5, D5, F5 (カード=数式) |

**検証手順:**
1. 各シートの「編集可能セル」にテスト値を入力 → 入力成功
2. 各シートの「保護セル」にテスト値を入力 → 「保護されています」エラー

### (c) データ検証の維持

| 手順 | 操作 | 期待結果 |
|------|------|----------|
| 1 | `Measure_Master!B2` をクリック | プルダウン矢印が表示される |
| 2 | プルダウンから案件 ID を選択 | 選択した値がセルに入力される |
| 3 | プルダウン外の値 (例: "INVALID") を直接入力 | エラーメッセージ表示、入力拒否 |
| 4 | `Kanban_View!B2` で同様の操作を実施 | データ検証が機能する |

### (d) VBA からの編集可否 (UserInterfaceOnly 動作)

| 手順 | 操作 | 期待結果 |
|------|------|----------|
| 1 | ブックを開き直す | `Workbook_Open` で `ProtectAllSheets` が実行される |
| 2 | `PRJ_001` シートのタスク行を選択し、Up ボタンをクリック | 行がスワップされる（VBA は保護を無視） |
| 3 | `Kanban_View` で `To Do` カードをダブルクリック | ステータスが「未着手」に更新される（VBA 経由） |
| 4 | 手動で `PRJ_001!F5` (終了日) を編集しようとする | 「保護されています」エラー（UI 操作は拒否） |

### (e) パスワード検証

| 手順 | 操作 | 期待結果 |
|------|------|----------|
| 1 | 「校閲」タブ → 「シート保護の解除」をクリック | パスワード入力ダイアログが表示される |
| 2 | 誤ったパスワードを入力 | 解除失敗 |
| 3 | 正しいパスワード (`pms-2024`) を入力 | 保護が解除される |
| 4 | 再度保護をかけ直す | 保護が適用される |

---

## 環境変数によるパスワード変更のテスト

```bash
# カスタムパスワードでブックを生成
PMS_SHEET_PASSWORD="my-secret-2024" python3 tools/build_workbook.py --projects 1

# Excel で開き、シート保護解除時に "my-secret-2024" で解除できることを確認
```

---

## チェックリスト

- [ ] (a) PRJ シートで行挿入可能、Case_Master で行挿入不可
- [ ] (b) 各シートの編集可能セルに入力可能
- [ ] (b) 各シートの保護セルに入力不可
- [ ] (c) データ検証がプルダウンとして機能
- [ ] (d) VBA マクロ (Up/Down, ダブルクリック) が正常動作
- [ ] (d) UI 操作での保護セル編集は拒否
- [ ] (e) 正しいパスワードで保護解除可能
